---
import Layout from '../layouts/Layout.astro';

const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="Discussions">
  <div class="space-y-6">
    <div>
      <h1 class="text-4xl font-bold mb-2">ðŸ’¬ GitHub Discussions</h1>
      <p class="text-lg opacity-70">
        Join the conversation and share ideas with the community
      </p>
    </div>

    <!-- Search -->
    <div class="form-control">
      <input
        type="text"
        id="discussion-search"
        placeholder="Search discussions..."
        class="input input-bordered w-full"
      />
    </div>

    <!-- New Discussion Button -->
    <div>
      <a
        href="https://github.com/cywf/gpt-builder/discussions/new"
        target="_blank"
        rel="noopener noreferrer"
        class="btn btn-primary"
      >
        Start New Discussion
      </a>
    </div>

    <!-- Discussions List -->
    <div id="discussions-container" class="space-y-4">
      <div class="text-center p-8">
        <span class="loading loading-spinner loading-lg"></span>
        <p class="mt-4">Loading discussions...</p>
      </div>
    </div>
  </div>
</Layout>

<script>
  const baseUrl = import.meta.env.BASE_URL;

  interface Discussion {
    title: string;
    url: string;
    author: string;
    createdAt: string;
    category: string;
    comments: number;
  }

  let allDiscussions: Discussion[] = [];

  async function loadDiscussions() {
    try {
      const response = await fetch(`${baseUrl}/data/discussions.json`);
      const discussions = await response.json();
      allDiscussions = discussions;
      renderDiscussions(discussions);
    } catch (error) {
      console.error('Failed to load discussions:', error);
      const container = document.getElementById('discussions-container');
      if (container) {
        container.innerHTML = `
          <div class="alert alert-warning">
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
              <h3 class="font-bold">No discussions loaded</h3>
              <div class="text-sm">Visit <a href="https://github.com/cywf/gpt-builder/discussions" target="_blank" rel="noopener noreferrer" class="link">GitHub Discussions</a> directly</div>
            </div>
          </div>
        `;
      }
    }
  }

  function renderDiscussions(discussions: Discussion[]) {
    const container = document.getElementById('discussions-container');
    if (!container) return;

    if (discussions.length === 0) {
      container.innerHTML = `
        <div class="alert alert-info">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h3 class="font-bold">No discussions found</h3>
            <div class="text-sm">Be the first to start a discussion!</div>
          </div>
        </div>
      `;
      return;
    }

    container.innerHTML = discussions
      .map(
        (discussion: Discussion) => `
      <div class="card bg-base-200 shadow-xl hover:shadow-2xl transition-shadow">
        <div class="card-body">
          <h3 class="card-title">
            <a href="${discussion.url}" target="_blank" rel="noopener noreferrer" class="link link-hover">
              ${discussion.title}
            </a>
          </h3>
          <div class="flex gap-2 items-center text-sm opacity-70">
            <span>by ${discussion.author}</span>
            <span>â€¢</span>
            <span>${new Date(discussion.createdAt).toLocaleDateString()}</span>
            <span>â€¢</span>
            <span>${discussion.comments} comments</span>
          </div>
          <div class="card-actions justify-start mt-2">
            <div class="badge badge-outline">${discussion.category}</div>
          </div>
        </div>
      </div>
    `
      )
      .join('');
  }

  // Search functionality
  const searchInput = document.getElementById('discussion-search') as HTMLInputElement;
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.toLowerCase();
      const filtered = allDiscussions.filter(
        (d) =>
          d.title.toLowerCase().includes(query) ||
          d.category.toLowerCase().includes(query) ||
          d.author.toLowerCase().includes(query)
      );
      renderDiscussions(filtered);
    });
  }

  loadDiscussions();
</script>
