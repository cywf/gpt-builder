name: Failed Run Notification

on:
  workflow_run:
    workflows: ["CI - Build and Test", "Docker Build and Push"]
    types:
      - completed

jobs:
  on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    permissions:
      issues: write
      actions: read
    
    steps:
      - name: Create issue for failed run
        uses: actions/github-script@v7
        with:
          script: |
            const workflow = context.payload.workflow_run;
            const runUrl = workflow.html_url;
            const runNumber = workflow.run_number;
            const workflowName = workflow.name;
            const branch = workflow.head_branch;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'failed-workflow',
              per_page: 100
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes(`Workflow Failed: ${workflowName}`) &&
              issue.title.includes(`#${runNumber}`)
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Workflow Failed: ${workflowName} #${runNumber} on ${branch}`,
                body: `## Workflow Failure Report
                
**Workflow:** ${workflowName}
**Run Number:** ${runNumber}
**Branch:** ${branch}
**Status:** Failed
**Run URL:** ${runUrl}

### Action Required
Please investigate the failed workflow run and take appropriate action.

This issue was automatically created by the failed run notification workflow.`,
                labels: ['failed-workflow', 'automation', 'needs-triage']
              });
            }
